# Resolve react_native_pods.rb with node to allow for hoisting
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

platform :ios, min_ios_version_supported
prepare_react_native_project!

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

target 'lecrepe-app' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      # :ccache_enabled => true
    )
    
    # Set deployment target to 13.0 to prevent iOS 15+ API issues
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      end
    end
    
    # Also update the main project deployment target
    installer.pods_project.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
    end
    
    # Patch react-native-screens to disable problematic props that cause crashes
    # These props are being applied to RCTView instead of RNSScreenView
    puts "Patching react-native-screens to disable problematic props..."
    pods_root = installer.sandbox.root
    project_root = File.join(installer.sandbox.project_path.dirname, '..')
    node_modules_path = File.join(project_root, 'node_modules', 'react-native-screens', 'ios')
    
    # Find RNSScreen.mm in Pods or node_modules
    rnsscreen_paths = []
    rnsscreen_paths.concat(Dir.glob(File.join(pods_root, '**', 'RNSScreen.mm')))
    rnsscreen_paths << File.join(node_modules_path, 'RNSScreen.mm') if File.exist?(File.join(node_modules_path, 'RNSScreen.mm'))
    
    rnsscreen_paths.uniq.each do |rnsscreen_path|
      if File.exist?(rnsscreen_path)
        content = File.read(rnsscreen_path)
        original_content = content.dup
        
        # Disable all problematic RCT_EXPORT_VIEW_PROPERTY that cause crashes
        # These props should only be used on RNSScreenView, not RCTView
        props_to_disable = [
          'activityState',  # This is remapped but still causes crashes
          'gestureResponseDistance',
          'gestureEnabled',
          'customAnimationOnSwipe',
          'fullScreenSwipeEnabled',
          'fullScreenSwipeShadowEnabled',
          'hideKeyboardOnSwipe',
          'preventNativeDismiss',
          'replaceAnimation',
          'stackPresentation',
          'stackAnimation',
          'swipeDirection',
          'transitionDuration',
          'screenId',
          'bottomScrollEdgeEffect',
          'leftScrollEdgeEffect',
          'rightScrollEdgeEffect',
          'topScrollEdgeEffect',
          'onAppear',
          'onDisappear',
          'onHeaderHeightChange',
          'onDismissed',
          'onNativeDismissCancelled',
          'onTransitionProgress',
          'onWillAppear',
          'onWillDisappear',
          'onGestureCancel',
          'onSheetDetentChanged',
          'sheetAllowedDetents',
          'sheetLargestUndimmedDetent',
          'sheetGrabberVisible',
          'sheetCornerRadius',
          'sheetInitialDetent',
          'sheetExpandsWhenScrolledToEdge'
        ]
        
        props_to_disable.each do |prop|
          # Match RCT_EXPORT_VIEW_PROPERTY(propName, ...) and comment it out
          # Handle different formats with flexible regex
          # First try exact match with type
          content.gsub!(/RCT_EXPORT_VIEW_PROPERTY\(#{Regexp.escape(prop)}, [^)]+\)/,
            "// RCT_EXPORT_VIEW_PROPERTY(#{prop}, ...); // Disabled to prevent crash on RCTView")
          # Then try without type (just prop name)
          content.gsub!(/RCT_EXPORT_VIEW_PROPERTY\(#{Regexp.escape(prop)}\)/,
            "// RCT_EXPORT_VIEW_PROPERTY(#{prop}); // Disabled to prevent crash on RCTView")
          # Also handle RCT_REMAP_VIEW_PROPERTY for activityState
          if prop == 'activityState'
            content.gsub!(/RCT_REMAP_VIEW_PROPERTY\(activityState, activityStateOrNil, NSNumber\)/,
              "// RCT_REMAP_VIEW_PROPERTY(activityState, activityStateOrNil, NSNumber); // Disabled to prevent crash on RCTView")
          end
        end
        
        # Also disable the setters in New Architecture code
        content.gsub!(/  \[self setGestureResponseDistance:/,
          "  // [self setGestureResponseDistance: // Disabled to prevent crash")
        content.gsub!(/  \[self setPreventNativeDismiss:/,
          "  // [self setPreventNativeDismiss: // Disabled to prevent crash")
        content.gsub!(/  \[self setSwipeDirection:/,
          "  // [self setSwipeDirection: // Disabled to prevent crash")
        content.gsub!(/  \[self setCustomAnimationOnSwipe:/,
          "  // [self setCustomAnimationOnSwipe: // Disabled to prevent crash")
        content.gsub!(/  \[self setFullScreenSwipeShadowEnabled:/,
          "  // [self setFullScreenSwipeShadowEnabled: // Disabled to prevent crash")
        content.gsub!(/  \[self setGestureEnabled:/,
          "  // [self setGestureEnabled: // Disabled to prevent crash")
        content.gsub!(/  \[self setTransitionDuration:/,
          "  // [self setTransitionDuration: // Disabled to prevent crash")
        content.gsub!(/  \[self setHideKeyboardOnSwipe:/,
          "  // [self setHideKeyboardOnSwipe: // Disabled to prevent crash")
        
        if content != original_content
          File.write(rnsscreen_path, content)
          puts "âœ… Patched #{File.basename(rnsscreen_path)}"
        end
      end
    end
  end
end
